generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model RFP {
  id                  String   @id
  businessName        String
  contactName         String
  email               String
  phone               String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime
  additionalInfo      String?
  biggestPainPoint    String?
  currentBookkeeping  String?
  hasInventory        String?
  hasPayroll          String?
  monthlyTransactions String?
  numBankAccounts     String?
  numCreditCards      String?
  preferredTime       String?
  accountCode         String?
  subAccount          String?
}

model accounts {
  id                      String                    @id
  plaidItemId             String?
  accountId               String                    @unique
  name                    String
  officialName            String?
  type                    String
  subtype                 String?
  createdAt               DateTime                  @default(now())
  updatedAt               DateTime
  availableBalance        Float?
  currentBalance          Float?
  isoCurrencyCode         String?
  mask                    String?
  userId                  String?
  accountCode             String?
  subAccount              String?
  entityType              String?
  source                  String                    @default("plaid") @db.VarChar(20)
  plaid_items             plaid_items?              @relation(fields: [plaidItemId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  users                   users?                    @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  investment_transactions investment_transactions[]

  transactions         transactions[]
  bank_reconciliations bank_reconciliations[]
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model category_coa_defaults {
  id                      String   @id @db.Uuid
  plaid_category_primary  String   @unique @db.VarChar(100)
  plaid_category_detailed String?  @db.VarChar(100)
  coa_code                String   @db.VarChar(50)
  entity_type             String?  @db.VarChar(10)
  created_at              DateTime @default(now())
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model chart_of_accounts {
  userId          String?
  id              String           @id @db.Uuid
  code            String           @unique @db.VarChar(50)
  name            String           @db.VarChar(255)
  account_type    String           @db.VarChar(50)
  balance_type    String           @db.Char(1)
  settled_balance BigInt           @default(0)
  pending_balance BigInt           @default(0)
  version         Int              @default(0)
  is_archived     Boolean          @default(false)
  entity_type     String?          @db.VarChar(10)
  module          String?          @db.VarChar(20)
  created_at      DateTime         @default(now())
  updated_at      DateTime         @default(now())
  user            users?           @relation(fields: [userId], references: [id])
  ledger_entries  ledger_entries[]
}

model closing_periods {
  id             String    @id
  periodEnd      DateTime
  periodType     String
  status         String    @default("open")
  closedAt       DateTime?
  closedBy       String?
  closingEntryId String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime
}

model investment_transactions {
  id                        String      @id
  investment_transaction_id String      @unique
  accountId                 String
  amount                    Float?
  cancel_transaction_id     String?
  date                      DateTime
  fees                      Float?
  iso_currency_code         String?
  name                      String
  price                     Float?
  quantity                  Float?
  security_id               String?
  subtype                   String?
  type                      String?
  unofficial_currency_code  String?
  createdAt                 DateTime    @default(now())
  updatedAt                 DateTime
  accountCode               String?
  subAccount                String?
  strategy                  String?
  tradeNum                  String?
  // Robinhood reconciliation fields
  rhQuantity                Float?      @map("rh_quantity")
  rhPrice                   Float?      @map("rh_price")
  rhPrincipal               Float?      @map("rh_principal")
  rhFees                    Float?      @map("rh_fees")
  rhTranFee                 Float?      @map("rh_tran_fee")
  rhContrFee                Float?      @map("rh_contr_fee")
  rhNetAmount               Float?      @map("rh_net_amount")
  rhAction                  String?     @map("rh_action") @db.VarChar(10)
  reconciliationStatus      String?     @map("reconciliation_status") @db.VarChar(30)
  isReconciled              Boolean     @default(false) @map("is_reconciled")
  reconciledAt              DateTime?   @map("reconciled_at")
  reconciledBy              String?     @map("reconciled_by") @db.VarChar(255)
  security                  securities? @relation(fields: [security_id], references: [securityId])
  accounts                  accounts    @relation(fields: [accountId], references: [id])
}

model journal_transactions {
  id                         String                 @id @db.Uuid
  transaction_date           DateTime
  description                String?
  external_transaction_id    String?                @db.VarChar(255)
  plaid_transaction_id       String?                @db.VarChar(255)
  document_id                String?                @db.Uuid
  posted_at                  DateTime?
  reversed_by_transaction_id String?                @db.Uuid
  created_by                 String?                @db.Uuid
  created_at                 DateTime               @default(now())
  updated_at                 DateTime               @default(now())
  account_code               String?                @db.VarChar(20)
  amount                     Int?
  strategy                   String?                @db.VarChar(50)
  trade_num                  String?                @db.VarChar(20)
  journal_transactions       journal_transactions?  @relation("journal_transactionsTojournal_transactions", fields: [reversed_by_transaction_id], references: [id])
  other_journal_transactions journal_transactions[] @relation("journal_transactionsTojournal_transactions")
  ledger_entries             ledger_entries[]

  @@index([transaction_date], map: "idx_transactions_date")
  @@index([external_transaction_id], map: "idx_transactions_external")
  @@index([plaid_transaction_id], map: "idx_transactions_plaid")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model ledger_entries {
  id                   String               @id @db.Uuid
  transaction_id       String               @db.Uuid
  account_id           String               @db.Uuid
  amount               BigInt
  entry_type           String               @db.Char(1)
  created_at           DateTime             @default(now())
  chart_of_accounts    chart_of_accounts    @relation(fields: [account_id], references: [id])
  journal_transactions journal_transactions @relation(fields: [transaction_id], references: [id])

  @@index([account_id, created_at], map: "idx_ledger_account_date")
  @@index([transaction_id], map: "idx_ledger_transaction")
}

model merchant_coa_mappings {
  id                      String   @id @db.Uuid
  merchant_name           String   @db.VarChar(255)
  plaid_category_primary  String?  @db.VarChar(100)
  plaid_category_detailed String?  @db.VarChar(100)
  coa_code                String   @db.VarChar(50)
  sub_account             String?  @db.VarChar(100)
  usage_count             Int      @default(1)
  confidence_score        Decimal  @default(1.0) @db.Decimal(3, 2)
  last_used_at            DateTime @default(now())
  created_at              DateTime @default(now())
  created_by              String?  @db.Uuid

  @@unique([merchant_name, plaid_category_primary])
  @@index([plaid_category_primary], map: "idx_category_lookup")
  @@index([merchant_name], map: "idx_merchant_lookup")
}

model plaid_items {
  id              String     @id
  userId          String
  itemId          String     @unique
  accessToken     String     @unique
  institutionId   String?
  institutionName String?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime
  accountCode     String?
  subAccount      String?
  accounts        accounts[]
  users           users      @relation(fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model prospects {
  id                  String   @id
  businessName        String
  contactName         String
  email               String
  phone               String?
  expenseTier         String?
  frequency           String?
  monthlyValue        Float?
  numBankAccounts     String?
  numCreditCards      String?
  monthlyTransactions String?
  hasPayroll          String?
  hasInventory        String?
  currentBookkeeping  String?
  biggestPainPoint    String?
  needs               String?
  timeline            String?
  status              String   @default("new")
  notes               String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime
  accountCode         String?
  subAccount          String?
  additionalInfo      String?
  currentTools        String?
  dreamSystem         String?
  enablement          String?
  hasData             String?
  problem             String?
  systemType          String?
  whyNow              String?
}

model securities {
  id                       String                    @id
  securityId               String                    @unique
  isin                     String?
  cusip                    String?
  sedol                    String?
  ticker_symbol            String?
  name                     String?
  type                     String?
  close_price              Float?
  close_price_as_of        DateTime?
  option_contract_type     String?
  option_strike_price      Float?
  option_expiration_date   DateTime?
  option_underlying_ticker String?
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime
  investment_transactions  investment_transactions[]
}

/// IRS-compliant position tracking for options trading
model trading_positions {
  id                      String    @id @default(uuid()) @db.Uuid
  open_investment_txn_id  String    @db.VarChar(255)
  symbol                  String    @db.VarChar(20)
  option_type             String?   @db.VarChar(10)
  strike_price            Float?
  expiration_date         DateTime?
  position_type           String    @db.VarChar(10)
  quantity                Float
  remaining_quantity      Float?
  open_price              Float
  open_fees               Float     @default(0)
  open_date               DateTime
  cost_basis              Float
  status                  String    @default("OPEN") @db.VarChar(10)
  close_investment_txn_id String?   @db.VarChar(255)
  close_price             Float?
  close_fees              Float?
  close_date              DateTime?
  proceeds                Float?
  realized_pl             Float?
  trade_num               String?   @db.VarChar(20)
  strategy                String?   @db.VarChar(50)
  created_at              DateTime  @default(now())
  updated_at              DateTime  @updatedAt

  @@index([open_investment_txn_id])
  @@index([close_investment_txn_id])
  @@index([symbol, expiration_date])
  @@index([status])
  @@index([trade_num])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
model transactions {
  id                                 String    @id
  accountId                          String
  transactionId                      String    @unique
  amount                             Float
  date                               DateTime
  name                               String
  merchantName                       String?
  category                           String?
  pending                            Boolean   @default(false)
  createdAt                          DateTime  @default(now())
  updatedAt                          DateTime
  authorized_date                    DateTime?
  authorized_datetime                DateTime?
  counterparties                     Json?
  location                           Json?
  payment_channel                    String?
  payment_meta                       Json?
  personal_finance_category          Json?
  personal_finance_category_icon_url String?
  transaction_code                   String?
  transaction_type                   String?
  logo_url                           String?
  website                            String?
  accountCode                        String?
  subAccount                         String?
  predicted_coa_code                 String?   @db.VarChar(20)
  prediction_confidence              Decimal?  @db.Decimal(3, 2)
  review_status                      String    @default("pending_review") @db.VarChar(20)
  manually_overridden                Boolean   @default(false)
  overridden_at                      DateTime?
  overridden_by                      String?   @db.VarChar(255)
  accounts                           accounts  @relation(fields: [accountId], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model users {
  id                   String                 @id
  email                String                 @unique
  password             String
  name                 String
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  accountCode          String?
  subAccount           String?
  tier                 String                 @default("free") @db.VarChar(20)
  stripeCustomerId     String?
  stripeSubscriptionId String?
  accounts             accounts[]
  plaid_items          plaid_items[]
  budgets              budgets[]
  journal_entries      journal_entries[]
  bank_reconciliations bank_reconciliations[]
  period_closes        period_closes[]
  trips                trips[]
  chart_of_accounts    chart_of_accounts[]
  budget_line_items    budget_line_items[]
  stock_lots           stock_lots[]
  tax_scenarios        tax_scenarios[]
  calendar_events      calendar_events[]
  home_expenses        home_expenses[]
  corporate_actions   corporate_actions[]
  trade_journal_entries trade_journal_entries[]
  tastytrade_connections tastytrade_connections[]
}

model budgets {
  id          String   @id @default(cuid())
  userId      String
  accountCode String
  year        Int
  jan         Decimal? @db.Decimal(12, 2)
  feb         Decimal? @db.Decimal(12, 2)
  mar         Decimal? @db.Decimal(12, 2)
  apr         Decimal? @db.Decimal(12, 2)
  may         Decimal? @db.Decimal(12, 2)
  jun         Decimal? @db.Decimal(12, 2)
  jul         Decimal? @db.Decimal(12, 2)
  aug         Decimal? @db.Decimal(12, 2)
  sep         Decimal? @db.Decimal(12, 2)
  oct         Decimal? @db.Decimal(12, 2)
  nov         Decimal? @db.Decimal(12, 2)
  dec         Decimal? @db.Decimal(12, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, accountCode, year])
}

model journal_entries {
  id          String                @id @default(cuid())
  userId      String
  entryNumber Int
  date        DateTime
  type        String // adjusting, reclassify, correction, accrual, closing
  memo        String?
  status      String                @default("draft") // draft, posted, voided
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  postedAt    DateTime?
  user        users                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  lines       journal_entry_lines[]

  @@unique([userId, entryNumber])
}

model journal_entry_lines {
  id             String          @id @default(cuid())
  journalEntryId String
  accountCode    String
  description    String?
  debit          Decimal?        @db.Decimal(12, 2)
  credit         Decimal?        @db.Decimal(12, 2)
  journalEntry   journal_entries @relation(fields: [journalEntryId], references: [id], onDelete: Cascade)
}

model bank_reconciliations {
  id                  String                 @id @default(cuid())
  userId              String
  accountId           String
  periodEnd           DateTime
  statementBalance    Decimal                @db.Decimal(12, 2)
  bookBalance         Decimal                @db.Decimal(12, 2)
  adjustedBankBalance Decimal?               @db.Decimal(12, 2)
  adjustedBookBalance Decimal?               @db.Decimal(12, 2)
  difference          Decimal?               @db.Decimal(12, 2)
  status              String                 @default("draft") // draft, reconciled
  reconciledAt        DateTime?
  createdAt           DateTime               @default(now())
  updatedAt           DateTime               @updatedAt
  user                users                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  account             accounts               @relation(fields: [accountId], references: [id], onDelete: Cascade)
  items               reconciliation_items[]

  @@unique([userId, accountId, periodEnd])
}

model reconciliation_items {
  id               String               @id @default(cuid())
  reconciliationId String
  transactionId    String?
  type             String // deposit_in_transit, outstanding_check, bank_fee, interest, other
  description      String
  amount           Decimal              @db.Decimal(12, 2)
  cleared          Boolean              @default(false)
  reconciliation   bank_reconciliations @relation(fields: [reconciliationId], references: [id], onDelete: Cascade)
}

model period_closes {
  id         String    @id @default(cuid())
  userId     String
  year       Int
  month      Int // 1-12
  status     String    @default("open") // open, closed
  closedAt   DateTime?
  closedBy   String?
  reopenedAt DateTime?
  reopenedBy String?
  notes      String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  user       users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, year, month])
}

model trips {
  id           String    @id @default(cuid())
  userId       String
  name         String    @db.VarChar(255)
  destination  String?   @db.VarChar(255)
  activity     String?   @db.VarChar(50)
  activities   String[]
  inviteToken  String?   @unique @db.VarChar(64)
  month        Int
  year         Int
  daysTravel   Int
  daysRiding   Int       @default(0)
  rsvpDeadline DateTime?
  ogImage      String?   @db.Text
  destinationPhoto String?   @db.Text
  status       String    @default("planning") @db.VarChar(20)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Committed trip details (set when trip is finalized)
  startDate    DateTime?
  endDate      DateTime?
  committedAt  DateTime?
  latitude     Decimal?  @db.Decimal(10, 6)
  longitude    Decimal?  @db.Decimal(10, 6)

  owner        users               @relation(fields: [userId], references: [id], onDelete: Cascade)
  participants trip_participants[]
  expenses     trip_expenses[]
  itinerary    trip_itinerary[]
  destinations trip_destinations[]
  budget_line_items budget_line_items[]

  @@index([userId])
  @@index([year, month])
  @@index([startDate, endDate])
}

model trip_participants {
  id              String    @id @default(cuid())
  tripId          String
  email           String    @db.VarChar(255)
  firstName       String    @db.VarChar(100)
  lastName        String    @db.VarChar(100)
  phone           String?   @db.VarChar(20)
  paymentMethod   String?   @db.VarChar(20)
  paymentHandle   String?   @db.VarChar(255)
  inviteToken     String    @unique @db.VarChar(64)
  passwordHash    String?
  unavailableDays Json?
  rsvpStatus      String    @default("pending") @db.VarChar(20)
  rsvpAt          DateTime?
  isOwner         Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  homeAirport     String?   @db.VarChar(10)
  homeAddress     String?   @db.VarChar(500)

  trip          trips            @relation(fields: [tripId], references: [id], onDelete: Cascade)
  expenseSplits expense_splits[]
  paidExpenses  trip_expenses[]  @relation("PaidBy")

  @@unique([tripId, email])
  @@index([inviteToken])
}

model trip_expenses {
  id          String   @id @default(cuid())
  tripId      String
  paidById    String
  plaidTxnId  String?  @db.VarChar(255)
  day         Int?
  category    String   @db.VarChar(50)
  vendor      String   @db.VarChar(255)
  description String?
  amount      Decimal  @db.Decimal(12, 2)
  date        DateTime
  isShared    Boolean  @default(false)
  splitCount  Int      @default(1)
  perPerson   Decimal? @db.Decimal(12, 2)
  location    String?  @db.VarChar(255)
  status      String   @default("pending") @db.VarChar(20)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  trip   trips             @relation(fields: [tripId], references: [id], onDelete: Cascade)
  paidBy trip_participants @relation("PaidBy", fields: [paidById], references: [id], onDelete: Cascade)
  splits expense_splits[]

  @@index([tripId])
  @@index([paidById])
  @@index([category])
}

model expense_splits {
  id            String    @id @default(cuid())
  expenseId     String
  participantId String
  amount        Decimal   @db.Decimal(12, 2)
  settled       Boolean   @default(false)
  settledAt     DateTime?
  createdAt     DateTime  @default(now())

  expense     trip_expenses     @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  participant trip_participants @relation(fields: [participantId], references: [id], onDelete: Cascade)

  @@unique([expenseId, participantId])
}

model trip_itinerary {
  id           String   @id @default(cuid())
  tripId       String
  day          Int
  homeDate     DateTime
  homeTime     String?  @db.VarChar(10)
  destDate     DateTime
  destTime     String?  @db.VarChar(10)
  category     String   @db.VarChar(50)
  vendor       String   @db.VarChar(255)
  cost         Decimal  @db.Decimal(12, 2)
  note         String?
  splitNames   String?
  splitBy      Int      @default(1)
  perPerson    Decimal? @db.Decimal(12, 2)
  location     String?  @db.VarChar(255)
  verticalDrop Int?
  avgSnow      Int?
  createdAt    DateTime @default(now())

  trip trips @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@index([tripId, day])
}

model ikon_resorts {
  id              String   @id @default(cuid())
  name            String   @unique @db.VarChar(255)
  region          String   @db.VarChar(100)
  country         String   @db.VarChar(100)
  state           String?  @db.VarChar(100)
  nearestAirport  String?  @db.VarChar(10)
  timezone        String?  @db.VarChar(50)
  verticalDrop    Int?
  avgSnowfall     Int?
  liftTicketDay   Decimal? @db.Decimal(10, 2)
  liftTicketMulti Decimal? @db.Decimal(10, 2)
  multiDayCount   Int?     @default(5)
  rentalBoardDay  Decimal? @db.Decimal(10, 2)
  rentalBootsDay  Decimal? @db.Decimal(10, 2)
  websiteUrl      String?  @db.VarChar(255)
  latitude        Decimal? @db.Decimal(10, 6)
  longitude       Decimal? @db.Decimal(10, 6)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([region])
  @@index([country])
}

model trip_destinations {
  id              String   @id @default(cuid())
  tripId          String
  resortId        String
  isSelected      Boolean  @default(true)
  estimatedTotal  Decimal? @db.Decimal(12, 2)
  createdAt       DateTime @default(now())

  trip            trips    @relation(fields: [tripId], references: [id], onDelete: Cascade)

  @@unique([tripId, resortId])
  @@index([tripId])
}

// ═══════════════════════════════════════════════════════════════════
// ACTIVITY DESTINATION TABLES
// ═══════════════════════════════════════════════════════════════════

model surf_spots {
  id              String   @id @default(cuid())
  name            String   @db.VarChar(255)
  country         String   @db.VarChar(100)
  region          String?  @db.VarChar(100)
  waveConsistency Int?     // 1-10 rating
  waveType        String?  @db.VarChar(50) // beach break, reef, point
  waterTempLow    Int?     // Fahrenheit
  waterTempHigh   Int?
  bestMonths      String?  @db.VarChar(100) // "May-Oct"
  wifiSpeed       Int?     // Mbps avg
  coworkingCount  Int?
  monthlyRent     Int?     // USD avg 1BR
  costIndex       Int?     // 1-10 (10=cheapest)
  nomadScore      Int?     // 1-10 community rating
  nearestAirport  String?  @db.VarChar(10)
  visaEase        String?  @db.VarChar(50) // "visa-free", "VOA", "e-visa"
  notes           String?  @db.Text
  latitude        Decimal?  @db.Decimal(10,6)
  longitude       Decimal?  @db.Decimal(10,6)
  createdAt       DateTime @default(now())
}

model golf_courses {
  id              String   @id @default(cuid())
  name            String   @db.VarChar(255)
  city            String   @db.VarChar(100)
  country         String   @db.VarChar(100)
  courseRating    Decimal? @db.Decimal(4,1)
  slopeRating     Int?
  greenFee        Int?     // USD typical
  holeCount       Int?     @default(18)
  sceneryRating   Int?     // 1-10
  monthlyRent     Int?     // USD avg 1BR nearby
  costIndex       Int?     // 1-10
  nomadScore      Int?     // 1-10
  nearestAirport  String?  @db.VarChar(10)
  visaEase        String?  @db.VarChar(50)
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
}

model cycling_destinations {
  id              String   @id @default(cuid())
  city            String   @db.VarChar(100)
  country         String   @db.VarChar(100)
  routeVariety    Int?     // 1-10
  terrainType     String?  @db.VarChar(100) // "flat", "hilly", "mountain"
  roadQuality     Int?     // 1-10
  bikeCulture     Int?     // 1-10
  rentalAvail     Boolean? @default(true)
  monthlyRent     Int?
  costIndex       Int?
  nomadScore      Int?
  nearestAirport  String?  @db.VarChar(10)
  visaEase        String?  @db.VarChar(50)
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
}

model race_destinations {
  id              String   @id @default(cuid())
  raceName        String   @db.VarChar(255)
  city            String   @db.VarChar(100)
  country         String   @db.VarChar(100)
  raceType        String   @db.VarChar(50) // "marathon", "half", "10k", "ultra"
  typicalMonth    String?  @db.VarChar(20)
  entryFee        Int?     // USD
  fieldSize       Int?
  courseType      String?  @db.VarChar(50) // "flat", "hilly", "trail"
  sceneryRating   Int?     // 1-10
  monthlyRent     Int?
  costIndex       Int?
  nomadScore      Int?
  nearestAirport  String?  @db.VarChar(10)
  visaEase        String?  @db.VarChar(50)
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
}

model triathlon_destinations {
  id              String   @id @default(cuid())
  eventName       String   @db.VarChar(255)
  city            String   @db.VarChar(100)
  country         String   @db.VarChar(100)
  distance        String   @db.VarChar(20) // "olympic", "70.3", "140.6"
  typicalMonth    String?  @db.VarChar(20)
  entryFee        Int?
  swimVenue       String?  @db.VarChar(100) // "ocean", "lake", "river"
  courseRating    Int?     // 1-10
  monthlyRent     Int?
  costIndex       Int?
  nomadScore      Int?
  nearestAirport  String?  @db.VarChar(10)
  visaEase        String?  @db.VarChar(50)
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
}

model festival_destinations {
  id              String   @id @default(cuid())
  festivalName    String   @db.VarChar(255)
  city            String   @db.VarChar(100)
  country         String   @db.VarChar(100)
  genre           String?  @db.VarChar(100) // "electronic", "rock", "multi-genre"
  typicalMonth    String?  @db.VarChar(20)
  durationDays    Int?
  ticketCost      Int?     // USD GA
  attendeeCount   Int?
  monthlyRent     Int?
  costIndex       Int?
  nomadScore      Int?
  nearestAirport  String?  @db.VarChar(10)
  visaEase        String?  @db.VarChar(50)
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
}

model skatepark_destinations {
  id              String   @id @default(cuid())
  parkName        String   @db.VarChar(255)
  city            String   @db.VarChar(100)
  country         String   @db.VarChar(100)
  parkRating      Int?     // 1-10
  parkSize        String?  @db.VarChar(50) // "small", "medium", "large", "mega"
  features        String?  @db.VarChar(255) // "bowl, street, vert, flow"
  streetSpots     Int?     // 1-10 nearby street skating
  monthlyRent     Int?
  costIndex       Int?
  nomadScore      Int?
  nearestAirport  String?  @db.VarChar(10)
  visaEase        String?  @db.VarChar(50)
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
}

model conference_destinations {
  id              String   @id @default(cuid())
  city            String   @db.VarChar(100)
  country         String   @db.VarChar(100)
  majorConferences String? @db.Text // JSON array of conference names
  startupScene    Int?     // 1-10
  fintechFocus    Int?     // 1-10
  vcPresence      Int?     // 1-10
  networkingScore Int?     // 1-10
  coworkingCount  Int?
  monthlyRent     Int?
  costIndex       Int?
  nomadScore      Int?
  nearestAirport  String?  @db.VarChar(10)
  visaEase        String?  @db.VarChar(50)
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
}

model nomad_cities {
  id              String   @id @default(cuid())
  city            String   @db.VarChar(100)
  country         String   @db.VarChar(100)
  region          String?  @db.VarChar(100)
  wifiSpeed       Int?     // Mbps avg
  coworkingCount  Int?
  monthlyRent     Int?     // USD 1BR
  costIndex       Int?     // 1-10 (10=cheapest)
  safetyRating    Int?     // 1-10
  weatherRating   Int?     // 1-10
  foodScene       Int?     // 1-10
  nightlife       Int?     // 1-10
  nomadCommunity  Int?     // 1-10
  visaEase        String?  @db.VarChar(50)
  nearestAirport  String?  @db.VarChar(10)
  timezone        String?  @db.VarChar(50)
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
}

// ═══════════════════════════════════════════════════════════════════
// NEXT-AUTH MODELS
// ═══════════════════════════════════════════════════════════════════

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}


// ═══════════════════════════════════════════════════════════════════
// NEW ACTIVITY DESTINATION TABLES
// ═══════════════════════════════════════════════════════════════════

model dining_destinations {
  id              String   @id @default(cuid())
  name            String   @db.VarChar(255)
  city            String   @db.VarChar(100)
  country         String   @db.VarChar(100)
  cuisineType     String?  @db.VarChar(100)
  priceLevel      Int?     // 1-4 ($-$$$$)
  michelinStars   Int?     // 0-3
  nomadScore      Int?     // 1-10
  wifiSpeed       Int?
  coworkingCount  Int?
  latitude        Decimal? @db.Decimal(10,6)
  longitude       Decimal? @db.Decimal(10,6)
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
}

model museum_destinations {
  id              String   @id @default(cuid())
  name            String   @db.VarChar(255)
  city            String   @db.VarChar(100)
  country         String   @db.VarChar(100)
  museumType      String?  @db.VarChar(100)  // contemporary, classical, mixed
  collectionSize  String?  @db.VarChar(50)   // small, medium, large, world-class
  nomadScore      Int?     // 1-10
  monthlyRent     Int?
  wifiSpeed       Int?
  latitude        Decimal? @db.Decimal(10,6)
  longitude       Decimal? @db.Decimal(10,6)
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
}

model swim_destinations {
  id              String   @id @default(cuid())
  name            String   @db.VarChar(255)
  country         String   @db.VarChar(100)
  region          String?  @db.VarChar(100)
  cliffHeight     Int?     // meters
  waterDepth      Int?     // meters
  difficulty      String?  @db.VarChar(50)   // beginner, intermediate, expert
  bestMonths      String?  @db.VarChar(100)
  nomadScore      Int?     // 1-10
  monthlyRent     Int?
  wifiSpeed       Int?
  latitude        Decimal? @db.Decimal(10,6)
  longitude       Decimal? @db.Decimal(10,6)
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
}

model rafting_destinations {
  id              String   @id @default(cuid())
  name            String   @db.VarChar(255)
  river           String?  @db.VarChar(255)
  country         String   @db.VarChar(100)
  region          String?  @db.VarChar(100)
  classRating     String?  @db.VarChar(20)   // I-VI
  seasonMonths    String?  @db.VarChar(100)
  tripLength      String?  @db.VarChar(50)   // half-day, full-day, multi-day
  nomadScore      Int?     // 1-10
  monthlyRent     Int?
  wifiSpeed       Int?
  latitude        Decimal? @db.Decimal(10,6)
  longitude       Decimal? @db.Decimal(10,6)
  notes           String?  @db.Text
  createdAt       DateTime @default(now())
}

// ═══════════════════════════════════════════════════════════════════
// BUDGET LINE ITEMS - Track trip expenses by COA code
// ═══════════════════════════════════════════════════════════════════

model budget_line_items {
  id            String   @id @default(cuid())
  userId        String
  tripId        String?
  itineraryId   String?
  coaCode       String   @db.VarChar(20)
  year          Int
  month         Int
  amount        Decimal  @db.Decimal(12, 2)
  description   String?
  photoUrl      String?
  source        String   @db.VarChar(20)  // 'trip', 'manual', 'recurring'
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  trip          trips?   @relation(fields: [tripId], references: [id], onDelete: SetNull)
  user          users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, year, month])
  @@index([tripId])
  @@index([coaCode])
}

model sail_destinations {
  id             String   @id @default(cuid())
  name           String   @db.VarChar(255)
  region         String?  @db.VarChar(100)
  country        String   @db.VarChar(100)
  nearestAirport String?  @map("nearestairport") @db.VarChar(10)
  timezone       String?  @db.VarChar(50)
  marinaFee      Decimal? @map("marinafee") @db.Decimal(10, 2)
  boatRentalDay  Decimal? @map("boatrentalday") @db.Decimal(10, 2)
  bestMonths     String?  @map("bestmonths") @db.VarChar(100)
  websiteUrl     String?  @map("websiteurl") @db.VarChar(255)
  latitude       Decimal? @db.Decimal(10, 6)
  longitude      Decimal? @db.Decimal(10, 6)
  createdAt      DateTime @default(now()) @map("createdat") @db.Timestamp(3)
}

// Google Places API cache to avoid repeated expensive calls
model places_cache {
  id              String   @id @default(cuid())
  placeId         String   @unique
  name            String
  address         String
  rating          Float?
  reviewCount     Int?
  priceLevel      Int?
  website         String?
  types           String?  // JSON array as string
  city            String
  country         String
  category        String   // coworking, lodging, etc.
  latitude        Float?
  longitude       Float?
  cachedAt        DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([city, country, category])
}

// ============================================
// LOT-BASED COST BASIS TRACKING
// ============================================

// Each stock purchase creates a lot with its own cost basis
model stock_lots {
  id                    String    @id @default(uuid()) @db.Uuid
  user_id               String
  investment_txn_id     String    @db.VarChar(255)  // Link to original buy transaction
  symbol                String    @db.VarChar(20)
  
  // Acquisition details
  acquired_date         DateTime
  original_quantity     Float                        // Shares purchased
  remaining_quantity    Float                        // Shares still held (decreases with sales)
  cost_per_share        Float                        // Price paid per share
  total_cost_basis      Float                        // Total cost including fees
  fees                  Float     @default(0)
  
  // Status
  status                String    @default("OPEN") @db.VarChar(20)  // OPEN, PARTIAL, CLOSED
  
  // Wash sale tracking
  wash_sale_disallowed  Float     @default(0)       // Disallowed loss amount
  wash_sale_adjustment  Float     @default(0)       // Cost basis adjustment from wash sale
  wash_sale_source_id   String?   @db.Uuid          // If this lot caused a wash sale, link to affected lot
  
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt
  
  // Relations
  user                  users     @relation(fields: [user_id], references: [id])
  dispositions          lot_dispositions[]
  adjustments           lot_adjustments[]
  
  @@index([user_id])
  @@index([symbol])
  @@index([status])
  @@index([acquired_date])
  @@index([investment_txn_id])
}

// Each sale creates disposition records linking to the lots being sold
model lot_dispositions {
  id                    String    @id @default(uuid()) @db.Uuid
  lot_id                String    @db.Uuid
  sale_txn_id           String    @db.VarChar(255)  // Link to sell transaction
  
  // Disposition details
  disposed_date         DateTime
  quantity_disposed     Float                        // Shares sold from this lot
  proceeds_per_share    Float                        // Sale price per share
  total_proceeds        Float                        // Total proceeds for this portion
  fees_allocated        Float     @default(0)       // Proportional fees
  
  // Calculated P&L
  cost_basis_disposed   Float                        // Cost basis of shares sold
  realized_gain_loss    Float                        // Proceeds - Cost Basis
  
  // Tax classification
  holding_period_days   Int                          // Days held
  is_long_term          Boolean                      // >= 365 days
  is_wash_sale          Boolean   @default(false)   // Loss disallowed?
  wash_sale_loss        Float     @default(0)       // Amount of loss disallowed
  
  // Method used
  matching_method       String    @db.VarChar(20)   // FIFO, LIFO, HIFO, SPECIFIC
  
  created_at            DateTime  @default(now())
  
  // Relations
  lot                   stock_lots @relation(fields: [lot_id], references: [id])
  
  @@index([lot_id])
  @@index([sale_txn_id])
  @@index([disposed_date])
}

// Store tax scenario comparisons for a potential sale
model tax_scenarios {
  id                    String    @id @default(uuid()) @db.Uuid
  user_id               String
  sale_txn_id           String?   @db.VarChar(255)  // Null if just simulating
  symbol                String    @db.VarChar(20)
  
  // Sale details
  sale_quantity         Float
  sale_price            Float
  sale_date             DateTime
  
  // Scenario results (JSON for flexibility)
  fifo_result           Json?                        // { stGain, ltGain, totalPL, estimatedTax, lots: [...] }
  lifo_result           Json?
  hifo_result           Json?                        // Highest In, First Out (tax loss harvesting)
  lofo_result           Json?                        // Lowest In, First Out
  specific_result       Json?                        // User-selected lots
  
  // Selected method (once committed)
  selected_method       String?   @db.VarChar(20)
  is_committed          Boolean   @default(false)
  
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt
  
  // Relations
  user                  users     @relation(fields: [user_id], references: [id])
  
  @@index([user_id])
  @@index([symbol])
  @@index([sale_txn_id])
}

// ============================================
// MISSING TABLES - RESTORED FROM DATABASE
// ============================================

model calendar_events {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id         String?
  source          String    @db.VarChar(20)
  source_id       String?
  title           String    @db.VarChar(255)
  description     String?
  category        String?   @db.VarChar(50)
  icon            String?   @db.VarChar(10)
  color           String?   @db.VarChar(20)
  start_date      DateTime  @db.Date
  end_date        DateTime? @db.Date
  is_recurring    Boolean?  @default(false)
  recurrence_rule String?   @db.VarChar(50)
  location        String?   @db.VarChar(255)
  latitude        Decimal?  @db.Decimal(10, 7)
  longitude       Decimal?  @db.Decimal(10, 7)
  coa_code        String?   @db.VarChar(50)
  budget_amount   Int?      @default(0)
  status          String?   @default("committed") @db.VarChar(20)
  created_at      DateTime? @default(now()) @db.Timestamp(6)
  updated_at      DateTime? @default(now()) @db.Timestamp(6)
  users           users?    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([source, source_id], map: "idx_calendar_events_source")
  @@index([user_id, start_date], map: "idx_calendar_events_user_date")
}

model home_expenses {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id      String?
  name         String    @db.VarChar(255)
  coa_code     String    @db.VarChar(50)
  amount       Int
  cadence      String?   @default("monthly") @db.VarChar(20)
  due_day      Int?
  start_date   DateTime? @db.Date
  end_date     DateTime? @db.Date
  is_active    Boolean?  @default(true)
  status       String?   @default("draft") @db.VarChar(20)
  committed_at DateTime? @db.Timestamp(6)
  created_at   DateTime? @default(now()) @db.Timestamp(6)
  updated_at   DateTime? @default(now()) @db.Timestamp(6)
  users        users?    @relation(fields: [user_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
}

model module_expenses {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id      String    @db.VarChar(255)
  module       String    @db.VarChar(50)
  name         String    @db.VarChar(255)
  coa_code     String    @db.VarChar(20)
  amount       Decimal   @db.Decimal(12, 2)
  cadence      String?   @default("monthly") @db.VarChar(20)
  due_day      Int?      @default(1)
  status       String?   @default("draft") @db.VarChar(20)
  committed_at DateTime? @db.Timestamp(6)
  created_at   DateTime? @default(now()) @db.Timestamp(6)
  updated_at   DateTime? @default(now()) @db.Timestamp(6)
  target_date  DateTime? @db.Date

  @@index([user_id, module], map: "idx_module_expenses_user_module")
}

// Corporate Actions - Track splits, dividends, mergers, spinoffs
model corporate_actions {
  id              String   @id @default(uuid())
  user_id         String
  symbol          String
  action_type     String   // SPLIT, REVERSE_SPLIT, STOCK_DIVIDEND, MERGER, SPINOFF
  effective_date  DateTime
  ratio_from      Int      // e.g., 1 for 1:50 reverse split
  ratio_to        Int      // e.g., 50 for 1:50 reverse split
  pre_split_shares  Float?   // Shares before action
  post_split_shares Float?   // Shares after action
  notes           String?
  source          String?  // SEC filing, broker statement, etc.
  created_at      DateTime @default(now())
  
  // Relations
  user            users    @relation(fields: [user_id], references: [id])
  lot_adjustments lot_adjustments[]
  
  @@index([user_id, symbol])
  @@index([effective_date])
}

// Lot Adjustments - Track how lots were modified by corporate actions
model lot_adjustments {
  id                  String   @id @default(uuid())
  lot_id              String   @db.Uuid
  corporate_action_id String
  original_quantity   Float
  adjusted_quantity   Float
  original_cost_per_share Float
  adjusted_cost_per_share Float
  adjustment_date     DateTime @default(now())
  
  // Relations
  lot               stock_lots        @relation(fields: [lot_id], references: [id])
  corporate_action  corporate_actions @relation(fields: [corporate_action_id], references: [id])
  
  @@index([lot_id])
  @@index([corporate_action_id])
}

model trade_journal_entries {
  id            String    @id @default(cuid())
  userId        String
  tradeNum      String    @db.VarChar(20)
  entryDate     DateTime  @default(now())
  entryType     String    @db.VarChar(20) // pre-trade, during, post-trade, review
  thesis        String?   @db.Text
  setup         String?   @db.VarChar(100) // technical setup name
  emotion       String?   @db.VarChar(20) // confident, nervous, fomo, revenge, neutral
  riskReward    String?   @db.VarChar(20) // planned R:R
  mistakes      String?   @db.Text
  lessons       String?   @db.Text
  rating        Int?      // 1-5 self-assessment
  aiAnalysis    String?   @db.Text
  tags          String[]
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  user          users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tradeNum])
  @@index([entryDate])
}

// ============================================
// TASTYTRADE BROKERAGE CONNECTIONS
// ============================================

model tastytrade_connections {
  id              String    @id @default(cuid())
  userId          String
  ttUsername       String    @db.VarChar(255)
  sessionToken    String    @db.Text
  rememberToken   String?   @db.Text
  accountNumbers  String[]
  status          String    @default("active") @db.VarChar(20) // active, expired, disconnected
  connectedAt     DateTime  @default(now())
  expiresAt       DateTime?
  lastUsedAt      DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  user            users     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId])
  @@index([status])
}
